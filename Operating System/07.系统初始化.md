# 系统初始化

## 启动流程

```mermaid
graph LR
    按下开关-->内核第一行代码
    内核第一行代码-->用户态应用代码
    用户态应用代码-->Shell代码
    Shell代码-->Shell等待输入
```

## 主要任务

- 配置页表并开启虚拟内存
  - 配置页表前使用物理地址，配置页表后使用虚拟地址
- 配置异常向量表并打开中断

## 总线

### 物理地址空间与物理内存空间

- 物理地址空间通常指系统总线的地址空间
  - 对64位系统，这个空s间大小为 $2^{64}$
- 系统总线连接内存，也连接其他设备，每个设备占一块空间
  - 通常内存确实占用了绝大部分空间

### 总线事务

- 总线上的设备可以向总线发起请求，称为**事务 Transaction**
  - 例如 `(1742, READ 102)` 该事务对总线上所有设备可见

## BootLoader

> “启动计算机，你需要运行代码；运行代码，你需要启动计算机”

- 以树莓派为例
  - 上电后固定从 `0x0` 地址运行 `firmware`，也称为 `bootloader`
  - `0x0` 不是物理内存的地址，而是连在总线上的某个存储介质的地址
  - 由这段代码处理 CPU、SDRAM
  - 然后加载内核、文件系统到内存
- 不同厂商的启动实现可能不同

### 入口函数

- CPU从预定义的物理内存地址读取第一行代码，由硬件厂商决定
  - 树莓派
    - 32位为 `0x8000`
    - 64位为 `0x80000`
  - x86
    - `0x7C00`

## BIOS

### BIOS 概述

> `Basic Input Output System`

1. 上电后，开始执行BIOS ROM中的代码
   - 自检测
   - 找到第一个可以启动的设备
   - 将可启动设备的第一个块加载到内存
   - 跳转到 `bootloader` 执行
2. 开始执行 `bootloader`
3. 内核代码开始执行

#### 什么是 BIOS

- 通常保存在主板的只读内存（ROM）中
- 仅仅是存储，没有执行能力
- 主要是为了PC的兼容性和扩展性
  - PC必须兼容不同的配件
  - 在没有插不同CPU或不同内存的需求的设备上，通常不需要BIOS
  - 在许多嵌入式设备中没有BIOS

#### 执行 BIOS

- 由 CPU 负责执行 BIOS
- `x86` CPU在reset后，`PC` 固定指向 `0xFFFF0`
  - 该地址即为 BIOS 的物理地址

### 上电自检 Power-On Self-Test POST

- 检查计算机的硬件设备能否满足运行的基本条件
- 如果硬件出现问题，则BIOS会发出不同含义的蜂鸣声

### 主引导记录 Master Boot Record MBR

- 在硬盘的前512字节
- 由三部分组成
  - 主引导程序 `bootloader`
  - 硬盘分区表 DPT
  - 硬盘有效标志 `0x55AA`

### 在一台电脑上安装多个操作系统

- Windows 会在 MBR 安装 NTLDR
- Linux 会在 MBR 安装 GRUB，可以选择 Windows 或 Linux
- 所以要先装 Windows 再装 Linux
- MacOS：世界上为什么还有别的操作系统呢
