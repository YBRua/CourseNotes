# 文件系统

## 文件

- 文件是对数据的一种抽象

文件
: 有名字且持久化的一段数据

```text
       ┌─────────┐ ┌─────────┐ ┌─────────┐
       │         │ │         │ │         │
User   │  App 1  │ │  App 2  │ │  App 3  │
       │         │ │         │ │         │
       └─────────┘ └─────────┘ └─────────┘

       ┌─────────────────────────────────┐
       │             File Sys            │
       └─────────────────────────────────┘
Kernel
       ┌─────────────────────────────────┐
       │              Driver             │
       └─────────────────────────────────┘

       ┌─────────────────────────────────┐
       │                                 │
HW     │         Memory and Disk         │
       │                                 │
       └─────────────────────────────────┘
```

## INODE

|        Layer        |          Purpose           |       Orientation       |
| :-----------------: | :------------------------: | :---------------------: |
|    Symbolic Link    |       Symbolic links       |          Human          |
| Abosolute Path Name |  Provide root for naming   |          Human          |
|      Path Name      |     Naming hierarchies     |          Human          |
|      File Name      |    Human-oriented names    | Human-Machine interface |
|    Inode Number     |   Machine-oriented names   |         Machine         |
|        File         | Organize blocks into files |         Machine         |
|        Block        |    Identify disk blocks    |         Machine         |

### 磁盘块层 Block Layer

$$磁盘块号 \to 磁盘上的数据$$

- 整个磁盘抽象成大数组
- 磁盘划分成很多块
  - 常见的块大小是 `4KB`
- 将磁盘块编号映射到磁盘块上的数据

#### 超级块 Super Block

- 每个文件系统在逻辑上有一个超级块
- 包含
  - 磁盘块大小
  - 磁盘块数量
  - 空闲磁盘块的bitmap的开始位置
    - 该bitmap记录了磁盘中空闲块的位置，但是并不直接存放在超级块内
- 超级块在逻辑上只有一个，但是物理上可以有多个备份
- 加载文件系统时，内核会读取超级块的信息

### 文件层 File Layer

$$ iNode \to 磁盘块号 $$

- 一个文件常常需要多个（甚至很多很多个）磁盘块才能存下，一个我们认知中的文件往往对应一大堆磁盘块，因此需要高效地记录并组织一个文件对应的存储块。
- 基于 inode 的文件系统使用 `inode` 记录每个文件所对应的所有磁盘块号
- 通过 `inode` 就可以访问一个文件的所有数据

```cpp
struct inode {
    int block_numbers[N];
    int size;
}
```

- `block_number` 记录了所有磁盘块号
- `size` 记录了大小

#### 多级磁盘块索引

- 如果只使用一级索引，那么 `inode` 预设的 `block_numbers` 数组可能不够，或者可能为了支持大文件而在存储小文件时产生大量浪费，因此使用多级磁盘块索引
- 类似多级页表
- `inode` 中保存了直接指针、一级间接指针和二级间接指针
  - 每个直接指针指向一个块
  - 每个间接指针存储了若干个上一级磁盘块的地址
  - 如果有必要，还可以启用三级、四级间接指针

#### 元数据

`inode` 除了记录存储索引外，还记录该文件相关的其他元数据，例如文件模式、链接数、拥有者、用户组、文件大小、访问时间、修改时间等

### INODE号层

$$iNodeNumber \to iNode$$

- inode表
  - 磁盘的固定位置存储了一个inode表，该表中记录了inode号到inode在表中的相对位置的映射。可以通过inode表找到特定的inode。
- 空闲inode bitmap
  - 记录了哪些inode被使用、哪些inode是空闲的

### 文件名层

$$FileNameString \to iNodeNumber$$

- inode号对于计算机已经足够，但是对人类而言非常不友好
  - 需要一个字符串形式的、对人类友好的文件名
- 而且直接使用inode号造成了inode号与文件存储位置的强耦合
  - 文件系统不能在不更改inode号的前提下更改文件inode的存储位置
  - 也不能用一个新的inode号指代已经存在的inode

#### 字符串文件名到`inode`号的映射

- 需要一个映射表记录文件名到`inode`号的映射
- 该映射表保存在 `目录` 中
- `目录` 本身也是一个文件，同样用 `inode` 组织
  - `目录` 大小和文件大小没有任何关系
  - 它的大小只和文件数量以及字符串文件名长度有关
  - 文件名也不是文件的元数据

> “这就是目录为什么叫目录，因为它就是一个目录”

#### 查目录

- 字符串匹配
- 返回对应的文件的 `inode` 号
- 如果找不到对应文件，则报错

### 路径层

- 提供结构化的路径名
  - 例如 `projects/paper`

### 绝对路径层

#### HOME目录

- 每个用户都有自己的HOME目录
  - 也是该用户登陆后的默认目录
  - 不同用户只能访问自己的HOME目录，不能跨用户共享文件

#### 根目录

- 通常规定根目录的 `inode` 编号为 `1`
- `/`

### 符号链接层

如何在一个磁盘上建立指向另一个磁盘的Link

- 不同磁盘的文件系统不同，因此 `inode` 命名空间不同
- 因此需要增加一种新的 inode 类型：软连接（符号链接）

## 硬链接与符号链接

### 硬链接

- 文件名并非元数据，因此一个文件可以对应多个文件名
  - 通过 `ln file link` 命令实现
  - 文件系统将先找到 `file` 对应的 `inode`，然后在目标路径的父目录下新增一个指向该 `inode` 的目录项
- 为了支持这个功能，`inode` 需要增加 Reference Counter `refcnt`
  - 用于记录有多少个文件名指向了当前的 `inode`
  - 只有 `refcnt == 0` 时才可以物理上移除该 `inode` 对应的文件
  - 但是通过任何一个文件名对文件的修改都将直接影响到这个文件
- Link不允许形成环，否则可能在磁盘中出现根目录无法访问，但是也不能删除的空间
  - 除了 `./` 和 `../`
- 或者在删除目录时必须保证当前目录为空
- 创建硬链接时，文件系统中不会创建新的文件，但是目录中会增加硬链接的条目

### 符号链接

- 会真实创建一个文件
  - 使用 `ln -s file slink` 创建
- 软连接是一个文件，里面保存了一个表示文件路径的字符串

## 文件元数据

- 拥有者 Owner、所在组 ID
  - 拥有改 `inode` 的用户ID和用户组ID
- 权限类型
  - 拥有者、所在组、其他
  - 读、写、执行
- 时间戳
  - 最后一次访问 (READ)
  - 最后一次修改 (WRITE)
  - 最后一次 `inode` 更新 (LINK)

## 小结

- 文件名并不是文件的一部分
  - 文件名不是文件的数据，也不是文件的元数据
    - 文件名并不保存在文件中
    - 文件名不在 `inode` 中
  - 文件名是目录的数据，是文件系统的元数据
  - 一个 `inode` 可以有多个文件名
    - 硬链接
- 每个硬链接的地位都是相同的
  - 文件名就是硬连接
- 目录所占磁盘空间通常很小
  - 目录仅仅负责记录文件名到 `inode` 的映射
