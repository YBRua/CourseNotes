# 文件系统

## 文件

- 文件是对数据的一种抽象

文件
: 有名字且持久化的一段数据

## INODE

| Layer | Purpose |
| :---: | :-----: |
|File||
|Block||

### 磁盘块层 Block Layer

- 整个磁盘抽象成大数组
- 磁盘划分成很多块
  - 常见的块大小是 `4KB`
- 将磁盘块编号映射到磁盘块上的数据

#### 超级块 Super Block

- 每个文件系统在逻辑上有一个超级块
- 包含
  - 磁盘块大小
  - 磁盘块数量
  - 空闲磁盘块的bitmap的开始位置
    - 该bitmap记录了磁盘中空闲块的位置，但是并不直接存放在超级块内
- 超级块在逻辑上只有一个，但是物理上可以有多个备份
- 加载文件系统时，内核会读取超级块的信息

### 文件层 File Layer

从 `inode` 映射到一个文件使用的所有磁盘块

```cpp
struct inode {
    int block_numbers[N];
    int size;
}
```

- `block_number`

#### 多级磁盘块索引

- 类似多级页表
- `inode` 可以指向间接磁盘块，每个磁盘块

### INODE号层

从 `inode` 号映射到 `inode`

### 文件名层

从字符串文件名映射到 `inode` 号

- 需要一个映射表记录文件名到`inode`号的映射
- 该映射表保存在 `目录` 中
- `目录` 本身也是一个文件，同样用 `inode` 组织
  - `目录` 大小和文件大小没有任何关系
  - 它的大小只和文件数量以及字符串文件名长度有关

> “这就是目录为什么叫目录，因为它就是一个目录”

#### 查目录

- 字符串匹配
- 返回对应的文件的 `inode` 号
- 如果找不到对应文件，则报错

### 路径层

### 绝对路径层

#### HOME目录

#### 根目录

通常规定根目录的 `inode` 编号为 `1`

### 符号链接层

如何在一个磁盘上建立指向另一个磁盘的Link

- 不同磁盘的文件系统不同，因此 `inode` 命名空间不同

## 硬链接与符号链接

### 硬链接

- 为了支持这个功能，`inode` 需要增加 Reference Counter `refcnt`
  - 用于记录有多少个文件名指向了当前的 `inode`
  - 只有 `refcnt == 0` 时才可以物理上移除该 `inode` 对应的文件
- Link不允许形成环，否则可能在磁盘中出现根目录无法访问，但是也不能删除的空间
  - 除了 `./` 和 `../`
- 或者在删除目录时必须保证当前目录为空
- 创建硬链接时，文件系统中不会创建新的文件，但是目录中会增加硬链接的条目

### 符号链接

- 会真实创建一个文件

## 文件元数据

- 拥有者 Owner、所在组 ID
  - 拥有改 `inode` 的用户ID和用户组ID
- 权限类型
  - 拥有者、所在组、其他
  - 读、写、执行
- 时间戳
  - 最后一次访问 (READ)
  - 最后一次修改 (WRITE)
  - 最后一次 `inode` 更新 (LINK)

## 小结

- 文件名并不是文件的一部分
  - 文件名不是文件的数据，也不是文件的元数据
    - 文件名并不保存在文件中
    - 文件名不在 `inode` 中
  - 文件名是目录的数据，是文件系统的元数据
  - 一个 `inode` 可以有多个文件名
    - 硬链接
- 每个硬链接的地位都是相同的
  - 文件名就是硬连接
- 目录所占磁盘空间通常很小
  - 目录仅仅负责记录文件名到 `inode` 的映射
